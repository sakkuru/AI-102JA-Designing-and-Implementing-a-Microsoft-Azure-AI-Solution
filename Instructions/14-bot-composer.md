---
lab:
    title: 'Bot Framework Composer を使用したボットの作成'
    module: 'モジュール 7 - 会話型 AI と the Azure Bot Service'
---

# Bot Framework Composer を使用したボットの作成

Bot Framework Composer は、コードを記述せずに高度な会話型ボットをすばやく簡単に構築できるグラフィカル デザイナーです。コンポーザーは、ボットを構築するためのビジュアル キャンバスを表示するオープン ソース ツールです。

## ボットを開発する準備をする

初めに、ボットの開発に必要なサービスとツールを準備します。

### OpenWeather API キーを取得する

この演習では、Open Weather サービスを使用してユーザーが入力した地域の気象条件を取得するボットを作成します。サービスを機能させるには、API キーが必要です。

1. Web ブラウザーで、OpenWeather サイト (`https://openweathermap.org/price`) にアクセスします。
2. 無料の API キーをリクエストし、OpenWeather アカウントを作成します (まだ持っていない場合)。
3. サインアップ後、**API keys** ページを表示して API キーを確認します。

### Bot Framework Composer を更新する

Bot Framework Composer を使用してボットを作成します。 このツールは、定期的に更新されるため、最新バージョンがインストールされていることを確認しましょう。

> **注**: 更新には、この演習の手順に影響を与えるユーザー インターフェイスの変更が含まれる場合があります。

1. **Bot Framework Composer** を起動し、更新をインストールするプロンプトが自動的表示されない場合は、**「ヘルプ」** メニューの **「更新の確認」** オプションを使用して更新を確認します。
2. アップデートがある場合は、アプリケーションを閉じたときにインストールを行うオプションを選択します。次に、Bot Framework Composer を閉じて、現在ログインしているユーザーのアップデートをインストールし、インストールの完了後に Bot Framework Composer を再起動します。インストールには数分かかることがあります。
3. Bot Framework Composer のバージョンが **2.0.0** 以降であることを確認します。

## ボットの作成

これで、Bot Framework Composer を使用してボットを作成する準備ができました。

### ボットを作成し、"welcome" ダイアログ フローをカスタマイズする

1. Bot Framework Composer がまだ開いていない場合は、起動します。
2. **ホーム**画面で、**「新規」** を選択します。次に、新しいC#のEmpty Botを作成します。**WeatherBot** という名前を付けて、RuntimeはAzure Web Appを選択し、ローカル フォルダーに保存します。
3. **「概要」** ペインが開いたら閉じ、左側のナビゲーション ペインで、**「Greeting」** を選択してオーサリング キャンバスを開き、ユーザーが最初にボットとの会話に参加したときに呼び出される *ConversationUpdate* アクティビティを表示します。アクティビティは、アクションのフローで構成されます。
4. 右側のプロパティペインで、右側のプロパティペインの上部にある **Greeting** という単語を選択し、**WelcomeUsers** に変更して、**Greeting** のタイトルを編集します。
5. オーサリング キャンバスで、**「応答の送信」** アクションを選択します。次に、プロパティ ペインで、既定のテキストを、*Hi to your bot* から`Hi! I'm WeatherBot.`に変更します
6. オーサリング キャンバスで、最後の **+** 記号 (ダイアログ フローの<u>終わり</u>を示す円のすぐ上) を選択し、**テキスト**応答の新しい**質問**アクションを追加します。

    新しいアクションにより、ダイアログフローに 2 つのノードが作成されます。最初のノードは、ボットがユーザーに質問するためのプロンプトを定義し、2 番目のノードは、ユーザーから受信される応答を表します。プロパティ ペインでは、これらのノードに対応する **「ボット回答」** タブと **「ユーザー入力」** タブがあります。

7. プロパティペインの **「ボット回答」** タブで、`What's your name?`というテキストの応答を追加します。次に、**「ユーザー入力」** タブで、**プロパティ値**を`user.name`に設定して、ボットの会話の後半でアクセスできる変数を定義します。
8. オーサリング キャンバスに戻り、追加した **「ユーザー入力 (テキスト)」** アクションの下の **+** 記号を選択し、**「応答の送信」** アクションを追加します。
9. 新しく追加された **「応答の送信」** アクションを選択し、プロパティ ペインで、テキスト値を`Hello ${user.name}, nice to meet you!`に設定します。

    完成したアクティビティ フローはこのようになります。

    ![ユーザーを歓迎し、名前を尋ねるダイアログ フロー](./images/welcomeUsers.png)

### ボットのテスト

基本的なボットが完成したのでテストしてみましょう。

1. Composer の右上隅にある **「ボットの開始」** を選択し、ボットがコンパイルされて開始されるまで待ちます。この処理には数分かかることがあります。

    - Windows ファイアウォール メッセージが表示された場合は、すべてのネットワークへのアクセスを有効にします。

2. **「ローカルボットランタイムマネージャー」** ペインで、**「Web チャットを開く」** を選択します。
3. しばらくすると、**WeatherBot** Web チャット ペインにウェルカム メッセージと名の入力を求めるメッセージが表示されます。  名を入力して **Enter** キーを押します。
4. ボットは、「**Hello *your_name*, nice to meet you!**」で応答するはずです。
5. Web チャットパネルを閉じます。
6. Composer の右上の **「ボットを再起動する」** の隣にある **<u>=</u>** をクリックして **「ローカル ボット ランタイム マネージャー」** ペインを開き、⏹ アイコンを使用してボットを停止します。

## 天気を取得するためのダイアログを追加する

これでボットが機能するようになったので、特定のインタラクションのダイアログを追加することでその機能を拡張できます。この場合、ユーザーが「weather」と言ったときにトリガーされるダイアログを追加します。

### ダイアログの追加

最初に、天気に関する質問を処理するために使用されるダイアログ フローを定義する必要があります。

1. Composer の 「ナビゲーション」 ペインで、最上位ノード (**WeatherBot**) と &#8285; メニューの上にマウスを置き、次に示すように、**「+ダイアログを追加」** を選択します。

    ![ダイアログ メニューの追加](./images/add-dialog.png)

    次に、**getWeather** という名前の新しいダイアログを作成し、**「Get the current weather condition for the provided zip code」** という説明を付けます。
2. 「ナビゲーション」 ペインで、新しい **getWeather** ダイアログの **BeginDialog** ノードを選択します。次に、オーサリング キャンバスで、**+** 記号を使用して、**テキスト**応答の**質問**アクションを追加します。
3. プロパティペインの **「ボット回答」** タブで、`Enter your city.`という応答を追加します。
4. **「ユーザー入力」** タブで、**「プロパティ」** フィールドを`dialog.city`に設定し、**「出力形式」** フィールドを式`=trim(this.value)`に設定して、ユーザーが指定した値の周囲の余分なスペースを削除します。

    これまでのアクティビティ フローはこのようになります。

    ![「応答の送信」アクションが 1 つあるダイアログ フロー](./images/getWeather-dialog-1.png)

    ここまでで、ダイアログはユーザーに地域を入力するように求めました。次に、入力された地域の天気情報を取得するロジックを実装する必要があります。

6. オーサリング キャンバスで、ユーザーの地域エントリの **「ユーザー入力」** アクションのすぐ下で、**+** 記号を選択して新しいアクションを追加します。
7. アクションのリストから、**「外部リソースへのアクセス」**、**「HTTP リクエストの送信」** の順に選択します。
8. **HTTP リクエスト**のプロパティを次のように設定し、**YOUR_API_KEY** を [OpenWeather](https://openweathermap.org/price) API キーに置き換えます
    - **HTTP メソッド**: GET
    - **Url**: `http://api.openweathermap.org/data/2.5/weather?units=metric&q=${dialog.city}&appid=YOUR_API_KEY`
    - **結果プロパティ**: `dialog.api_response`

    結果には、HTTP 応答からの次の 4 つのプロパティのいずれかを含めることができます。

    - **statusCode**。**dialog.api_response.statusCode** を介してアクセスします。
    - **reasonPhrase**。**dialog.api_response.reasonPhrase** を介してアクセスします。
    - **content**。**dialog.api_response.content** を介してアクセスします。
    - **headers**。**dialog.api_response.headers** を介してアクセスします。

    さらに、応答タイプが JSON の場合、**dialog.api_response.content** プロパティを介して利用できる逆シリアル化されたオブジェクトになります。OpenWeather API とそれが返す応答の詳細については、[OpenWeather API のドキュメント](https://openweathermap.org/current)を参照してください。

    次に、応答を処理するロジックをダイアログ フローに追加する必要があります。これにより、HTTP 要求が成功か失敗かを示します。

9. オーサリング キャンバスで、作成した **「HTTP リクエストの送信アクション」** の下に、**「条件ブランチの作成** > **:if/else」** アクションを追加します。このアクションは、**True** パスと **False** パスを使用してダイアログ フローのブランチを定義します。
10. ブランチ アクションの **「プロパティ」** で、次の式を書き込むように **「条件」** フィールドを設定します。

    ```
    =dialog.api_response.statusCode == 200
    ```

11. 呼び出しが成功した場合は、応答を変数に格納する必要があります。オーサリング キャンバスの **True**ブランチで、**「プロパティの管理」** > **「プロパティの設定」** アクションを追加します。プロパティ ウィンドウで、次のプロパティの割り当てを追加します。

    | プロパティ | 値 |
    | -- | -- |
    | `dialog.weather` | `=dialog.api_response.content.weather[0].description` |
    | `dialog.temp` | `=round(dialog.api_response.content.main.temp)` |
    | `dialog.icon` | `=dialog.api_response.content.weather[0].icon` |

12. まだ **True** ブランチで、**「プロパティの設定」** アクションの下に **「応答の送信」** アクションを追加し、そのテキストを次のように設定します。

    ```
    The weather in ${dialog.city} is ${dialog.weather} and the temperature is ${dialog.temp}&deg;.
    ```

    ***注**: このメッセージは、前のアクションで設定した **dialog.city**、**dialog.weather**、および **dialog.temp** プロパティを使用します。後に、**dialog.icon** プロパティも使用します。*

13. 200 以外の気象サービスからの応答も考慮する必要があるため、**False** ブランチで、**「応答の送信」** アクションを追加し、そのテキストを `I got an error: ${dialog.api_response.content.message}.`に設定します。

    ダイアログ フローは次のようなります。

    ![HTTP 応答結果のブランチを含むダイアログ フロー](./images/getWeather-dialog-2.png)

### ダイアログのトリガーを追加する

ここで、既存のウェルカム ダイアログから新しいダイアログを開始する方法が必要です。

1. 「ナビゲーション」 ペインで、**WelcomeUsers** を含む **WeatherBot** ダイアログを選択します (これは同じ名前のトップレベルのボット ノードの下にあります)。

    ![選択した WeatherBot ワークフロー](./images/select-workflow.png)

2. 選択した **WeatherBot** ダイアログのプロパティ ペインの **「Language Understanding」** セクションで、**「認識」** タイプを **「正規表現認識」** に設定します。

    > 既定の認識タイプは、Language Understanding サービスを使用して、自然言語理解モデルを使用してユーザーの意図を生成します。この演習を簡略化するために、正規表現認識機能を使用しています。実際のアプリケーションでは、Language Understanding を使用して、より高度な意図認識を可能にすることを検討する必要があります。

3. **「WeatherBot」** メニューで、**「新しいトリガーの追加」** を選択します。

    ![トリガー メニューを追加する](./images/add-trigger.png)

    次に、次の設定でトリガーを作成します。

    - **What is the type of this trigger?**: 意図の認識
    - **What is the name of this trigger (RegEx)**:  `WeatherRequested`
    - **Please input regex pattern**: `weather`

    > 入力されたテキストを正規表現パターンのテキストボックスは、ボットが着信メッセージで *weather* という単語を検索するようにする単純な正規表現パターンです。  「weather」が存在する場合、メッセージは**認識された意図**になり、トリガーが開始されます。

4. トリガーが作成されたので、そのためのアクションを構成する必要があります。トリガーのオーサリング キャンバスで、新しい **WeatherRequested** トリガー ノードの下にある **+** 記号を選択します。次に、アクションのリストで、**「ダイアログ管理」** を選択し、**「新しいダイアログの開始」** を選択します。
5. 「**新しいダイアログの開始**」 アクションを選択した状態で、「プロパティ」 ペインで、「ダイアログ名」 ドロップダウン リストから **GetWeather** ダイアログを選択し、**WeatherRequested** トリガーが認識されたときに前に定義した **getWeather** ダイアログを開始します。

    **WeatherRequested** アクティビティ フローは次のようになります。

    ![regex トリガーによる getWeather ダイアログの開始](./images/weather-regex.png)

6. ボットを再起動して Web チャットペインを開き、会話を再開し、名前を入力した後、`What is the weather like?`と入力します。プロンプトが表示されたら、`Seattle`などの地域を入力します。ボットがサービスに問い合わせ、天気予報を示す簡単な文で応答します。
7. テストが完了したら、Web チャット ウィンドウを閉じ、ボットを停止します。

## 割り込みの処理

適切に設計されたボットは、ユーザーが、たとえば要求をキャンセルすることによって、会話の流れを変更できるようにする必要があります。

1. Bot Composer の 「ナビゲーション」 ペインで、**「WeatherBot」** ダイアログ 「&#8285;」 メニューを使用します (既存の **WelcomeUsers** および **WeatherRequested** トリガーに加えて) 新しいトリガーを追加します。新しいトリガーには、次の設定が必要です。

    - **What is the type of this trigger?**: 意図の認識
    - **What is the name of this trigger (RegEx)**:  `CancelRequest`
    - **Please input regex pattern**: `cancel`

    > テキストに入力されたテキストボックスは単純な正規表現パターンであり、ボットは着信メッセージで *cancel* という単語を検索します。

2. トリガーのオーサリングキャンバスで、**「応答の送信」** アクションを追加し、そのテキスト応答を`OK.Whenever you're ready, you can ask me about the weather.`に設定します。
3. **「応答の送信」** アクションで、**「ダイアログ管理」** と **「このダイアログの終了」** を選択して、ダイアログに新しいアクションを追加します。

    **CancelRequest** ダイアログ フローは次のようになります。

    ![応答の送信とこのダイアログアクションの終了を伴う CancelRequest トリガー](./images/cancel-dialog.png)

    ユーザーのキャンセル要求に応答するトリガーができたので、天気情報を要求した後に郵便番号の入力を求められた場合など、ユーザーがそのような要求を行う可能性のあるダイアログ フローの中断を許可する必要があります。

4. ナビゲーション ペインで、**「getWeather」** ダイアログの下の **「BeginDialog」** を選択します。
5. ユーザーに地域の入力を求める **「テキストの入力を求める」** アクションを選択します。
6. アクションのプロパティの **「その他」** タブで、**「プロンプト構成」** を展開し、**「中断を許可」** プロパティを **「True」** に設定します。
7. ボットを再起動し、Web チャット ペインを開きます。会話を再開し、名前を入力した後、`What is the weather like?`と入力します。次に、プロンプトが表示されたら、 `cancel`と入力し、リクエストがキャンセルされたことを確認します。
8. リクエストをキャンセルした後、`What's the weather like?`と入力し、適切なトリガーによって **「GetWeather」** ダイアログの新しいインスタンスが開始され、郵便番号の入力を再度求められることに注意してください。
9. テストが完了したら、Web チャット ウィンドウを閉じ、ボットを停止します。

## ユーザー エクスペリエンスを強化する

これまでの気象ボットとのやり取りは、テキストを介して行われました。  ユーザーは意図したとおりにテキストを入力すると、ボットはテキストで応答します。多くの場合、テキストはコミュニケーションに適した方法ですが、他の形式のユーザー インターフェイス要素を使用してエクスペリエンスを向上させることができます。  たとえば、ボタンを使用して推奨されるアクションを開始したり、*カード*を表示して情報を視覚的に表示したりできます。

### ボタンの追加

1. Bot Framework Composer の 「ナビゲーション」 ペインの **「GetWeather」** アクションで、**「BeginDialog」** を選択します。
2. 作成キャンバスで、地域のプロンプトを含む **「Prompt for text」\(テキストのプロンプト\)** アクションを選択します。
3. プロパティペインで、**「コードを表示する」** を選択し、既存のコードを次のコードに置き換えます。

```
[Activity    
    Text = Enter your city.
    SuggestedActions = Cancel
]
```

このアクティビティでは、以前と同じようにユーザーに地域の入力を求めますが、**「キャンセル」** ボタンも表示します。

### カードを追加する

1. **「getWeather」** ダイアログの HTTP 天気サービスからの応答を確認した後の **True** パスで、天気レポートを表示する **「応答の送信」** アクションを選択します。
2. プロパティペインで、**「コードを表示する」** を選択し、既存のコードを次のコードに置き換えます。

```
[ThumbnailCard
    title = Weather for ${dialog.city}
    text = ${dialog.weather} (${dialog.temp}&deg;)
    image = http://openweathermap.org/img/w/${dialog.icon}.png
]
```

このテンプレートは、気象条件に対して以前と同じ変数を使用しますが、気象条件の画像とともに、表示されるカードにタイトルも追加します。

### 新しいユーザー インターフェイスをテストする

1. ボットを再起動し、Web チャット ペインを開きます。会話を再開し、名前を入力した後、`What is the weather like?`と入力します。次に、プロンプトが表示されたら、**「キャンセル」** ボタンをクリックしてリクエストをキャンセルします。
2. キャンセル後、`Tell me about the weather`と入力し、プロンプトが表示されたら、`London`などの有効な地域名を入力します。ボットはサービスに連絡し、気象条件を示すカードで応答する必要があります。
3. テストが終了したら、エミュレーターを閉じてボットを停止します。

## 詳細

Bot Framework Composer の詳細については、[Bot Framework Composerのドキュメント](https://docs.microsoft.com/composer/introduction)を参照してください。
